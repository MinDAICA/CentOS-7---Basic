Ráº¥t hay luÃ´n Dong Æ¡i! Náº¿u báº¡n muá»‘n sau má»—i láº§n khá»Ÿi Ä‘á»™ng láº¡i CentOS 7, há»‡ thá»‘ng Kubernetes tá»± Ä‘á»™ng khá»Ÿi Ä‘á»™ng Ä‘áº§y Ä‘á»§ (kubelet, API server, cáº¥u hÃ¬nh kubectl, v.v.), thÃ¬ mÃ¬nh sáº½ hÆ°á»›ng dáº«n báº¡n thiáº¿t láº­p má»™t cÃ¡ch á»•n Ä‘á»‹nh vÃ  tá»± Ä‘á»™ng hÃ³a.

âœ… Má»¥c tiÃªu: Sau khi reboot, Kubernetes master node hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng mÃ  khÃ´ng cáº§n thao tÃ¡c tay.
ğŸ›  CÃ¡c bÆ°á»›c cáº¥u hÃ¬nh tá»± Ä‘á»™ng sau reboot
ğŸ”¹ BÆ°á»›c 1: Äáº£m báº£o kubelet khá»Ÿi Ä‘á»™ng cÃ¹ng há»‡ thá»‘ng
bash
systemctl enable kubelet
â†’ Äiá»u nÃ y giÃºp kubelet tá»± cháº¡y khi mÃ¡y khá»Ÿi Ä‘á»™ng.

ğŸ”¹ BÆ°á»›c 2: Äáº£m báº£o file ~/.kube/config luÃ´n tá»“n táº¡i
Náº¿u báº¡n dÃ¹ng user root, thÃ¬ file nÃ y nÃªn Ä‘Æ°á»£c copy tá»« admin.conf sau má»—i reboot (náº¿u bá»‹ máº¥t). Báº¡n cÃ³ thá»ƒ táº¡o má»™t script tá»± Ä‘á»™ng:

ğŸ“„ Táº¡o file /usr/local/bin/k8s-init.sh
bash
#!/bin/bash

# Kiá»ƒm tra náº¿u file config chÆ°a tá»“n táº¡i
if [ ! -f /root/.kube/config ]; then
  mkdir -p /root/.kube
  cp -i /etc/kubernetes/admin.conf /root/.kube/config
  chown $(id -u):$(id -g) /root/.kube/config
fi
ğŸ” Táº¡o systemd service Ä‘á»ƒ cháº¡y script sau reboot
bash
vi /etc/systemd/system/k8s-init.service
Ná»™i dung:

ini
[Unit]
Description=Kubernetes Config Restore
After=network.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/k8s-init.sh

[Install]
WantedBy=multi-user.target
KÃ­ch hoáº¡t service:

bash
chmod +x /usr/local/bin/k8s-init.sh
systemctl daemon-reexec
systemctl daemon-reload
systemctl enable k8s-init
ğŸ”¹ BÆ°á»›c 3: Kiá»ƒm tra container runtime (Docker hoáº·c containerd)
Äáº£m báº£o Docker cÅ©ng khá»Ÿi Ä‘á»™ng cÃ¹ng há»‡ thá»‘ng:

bash
systemctl enable docker
ğŸ”¹ BÆ°á»›c 4: Kiá»ƒm tra cÃ¡c manifest trong /etc/kubernetes/manifests/
Kubernetes sáº½ tá»± khá»Ÿi Ä‘á»™ng cÃ¡c thÃ nh pháº§n control plane (API server, scheduler, controller-manager) náº¿u cÃ¡c file YAML nÃ y tá»“n táº¡i.

â†’ KhÃ´ng cáº§n cháº¡y láº¡i kubeadm init náº¿u báº¡n giá»¯ nguyÃªn thÆ° má»¥c nÃ y.

ğŸ¯ Káº¿t quáº£ sau khi reboot
kubelet tá»± cháº¡y.

kubectl hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng.

Cluster tá»± khá»Ÿi Ä‘á»™ng láº¡i.

Báº¡n cÃ³ thá»ƒ dÃ¹ng kubectl get nodes ngay sau khi mÃ¡y lÃªn.



--> CHÃNH XÃC HÆ N! -----> 

Tuyá»‡t vá»i luÃ´n, Dong Æ¡i! DÆ°á»›i Ä‘Ã¢y lÃ  toÃ n bá»™ script tá»± Ä‘á»™ng hÃ³a giÃºp báº¡n kiá»ƒm tra vÃ  khá»Ÿi Ä‘á»™ng láº¡i cÃ¡c thÃ nh pháº§n Kubernetes sau má»—i láº§n reboot â€” Ã¡p dá»¥ng cho cáº£ master node vÃ  worker node trÃªn CentOS 7. Script nÃ y Ä‘áº£m báº£o:

kubelet luÃ´n cháº¡y.

Docker/containerd luÃ´n sáºµn sÃ ng.

File ~/.kube/config Ä‘Æ°á»£c khÃ´i phá»¥c (chá»‰ trÃªn master).

Swap Ä‘Æ°á»£c táº¯t.

Log Ä‘Æ°á»£c ghi láº¡i Ä‘á»ƒ dá»… kiá»ƒm tra.

ğŸ“„ Script: /usr/local/bin/k8s-autostart.sh
bash
#!/bin/bash

echo "[K8s AutoStart] Báº¯t Ä‘áº§u kiá»ƒm tra há»‡ thá»‘ng..."

# Táº¯t swap náº¿u Ä‘ang báº­t
if swapon --summary | grep -q 'dev'; then
  echo "[K8s AutoStart] Táº¯t swap..."
  swapoff -a
fi

# Khá»Ÿi Ä‘á»™ng Docker náº¿u chÆ°a cháº¡y
if ! systemctl is-active --quiet docker; then
  echo "[K8s AutoStart] Khá»Ÿi Ä‘á»™ng Docker..."
  systemctl start docker
fi

# Khá»Ÿi Ä‘á»™ng kubelet náº¿u chÆ°a cháº¡y
if ! systemctl is-active --quiet kubelet; then
  echo "[K8s AutoStart] Khá»Ÿi Ä‘á»™ng kubelet..."
  systemctl start kubelet
fi

# Chá»‰ dÃ nh cho master node: khÃ´i phá»¥c ~/.kube/config náº¿u máº¥t
if hostname | grep -q "master"; then
  if [ ! -f /root/.kube/config ]; then
    echo "[K8s AutoStart] KhÃ´i phá»¥c file kube config cho master..."
    mkdir -p /root/.kube
    cp -i /etc/kubernetes/admin.conf /root/.kube/config
    chown $(id -u):$(id -g) /root/.kube/config
  fi
fi

echo "[K8s AutoStart] HoÃ n táº¥t khá»Ÿi Ä‘á»™ng há»‡ thá»‘ng Kubernetes."
âš™ï¸ Táº¡o systemd service Ä‘á»ƒ cháº¡y sau reboot
bash
vi /etc/systemd/system/k8s-autostart.service
Ná»™i dung:

ini
[Unit]
Description=Kubernetes AutoStart Script
After=network.target docker.service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/k8s-autostart.sh

[Install]
WantedBy=multi-user.target
ğŸ” KÃ­ch hoáº¡t service
bash
chmod +x /usr/local/bin/k8s-autostart.sh
systemctl daemon-reexec
systemctl daemon-reload
systemctl enable k8s-autostart
âœ… Sau khi reboot
Master node sáº½ cÃ³ kubectl hoáº¡t Ä‘á»™ng ngay.

Worker node sáº½ tá»± káº¿t ná»‘i láº¡i cluster.

KhÃ´ng cáº§n cháº¡y láº¡i kubeadm join hoáº·c init.

Swap luÃ´n táº¯t, Docker vÃ  kubelet luÃ´n cháº¡y.

